# Design Consistency Audit - Fix Plan

**Created**: 2025-10-13
**Based on**: 2025-10-13-audit-findings.md
**Estimated Time**: Phase 1: 1 hour, Phase 2: 3 hours, Phase 3: 5 hours

---

## Phase 1: Critical Fixes (REQUIRED BEFORE ANY OTHER WORK)

### Fix 1.1: Add payload_size to persist_event INSERT

**Priority**: ðŸ”´ CRITICAL BLOCKER
**File**: `crates/kapsel-api/src/handlers/ingest.rs`
**Estimated Time**: 5 minutes

**Current Code** (lines 255-280):
```rust
async fn persist_event(
    db: &PgPool,
    event_id: EventId,
    tenant_id: TenantId,
    endpoint_id: EndpointId,
    idempotency_key: String,
    headers: serde_json::Value,
    body: Bytes,
    content_type: String,
) -> sqlx::Result<()> {
    sqlx::query(
        r"
        INSERT INTO webhook_events (
            id, tenant_id, endpoint_id, source_event_id,
            idempotency_strategy, status, headers, body,
            content_type, received_at, failure_count
        )
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, 0)
        "
    )
    .bind(event_id.0)
    .bind(tenant_id.0)
    .bind(endpoint_id.0)
    .bind(idempotency_key)
    .bind("header") // Using header-based idempotency for now
    .bind(EventStatus::Received.to_string())
    .bind(headers)
    .bind(body.as_ref())
    .bind(content_type)
    .bind(Utc::now())
    .execute(db)
    .await?;

    Ok(())
}
```

**Fixed Code**:
```rust
async fn persist_event(
    db: &PgPool,
    event_id: EventId,
    tenant_id: TenantId,
    endpoint_id: EndpointId,
    idempotency_key: String,
    headers: serde_json::Value,
    body: Bytes,
    content_type: String,
) -> sqlx::Result<()> {
    // Calculate payload size, ensuring at least 1 to satisfy CHECK constraint
    let payload_size = (body.len() as i32).max(1);

    sqlx::query(
        r"
        INSERT INTO webhook_events (
            id, tenant_id, endpoint_id, source_event_id,
            idempotency_strategy, status, headers, body,
            content_type, payload_size, received_at, failure_count
        )
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, 0)
        "
    )
    .bind(event_id.0)
    .bind(tenant_id.0)
    .bind(endpoint_id.0)
    .bind(idempotency_key)
    .bind("header") // Using header-based idempotency for now
    .bind(EventStatus::Received.to_string())
    .bind(headers)
    .bind(body.as_ref())
    .bind(content_type)
    .bind(payload_size)
    .bind(Utc::now())
    .execute(db)
    .await?;

    Ok(())
}
```

**Testing**:
```bash
# Run property tests (will catch this immediately)
cargo test --test property_tests

# Run integration tests
cargo test --test webhook_ingestion_test
```

**Commit Message**:
```
fix(api): add payload_size column to webhook_events INSERT

The persist_event function was missing the payload_size column in its
INSERT statement, causing all webhook ingestion to fail with a
database constraint violation (NOT NULL constraint).

This adds payload_size calculation (body.len() as i32, min 1) and
includes it in the INSERT statement.

Fixes audit finding 4.1 (CRITICAL BLOCKER).
```

---

### Fix 1.2: Add missing fields to WebhookEvent struct

**Priority**: ðŸ”´ CRITICAL
**File**: `crates/kapsel-core/src/models.rs`
**Estimated Time**: 15 minutes

**Current Code** (lines 191-255):
```rust
pub struct WebhookEvent {
    pub id: EventId,
    pub tenant_id: TenantId,
    pub endpoint_id: EndpointId,
    pub source_event_id: String,
    pub idempotency_strategy: String,
    pub status: EventStatus,
    pub failure_count: u32,
    pub last_attempt_at: Option<DateTime<Utc>>,
    pub next_retry_at: Option<DateTime<Utc>>,
    pub headers: HashMap<String, String>,
    pub body: Bytes,
    pub content_type: String,
    pub received_at: DateTime<Utc>,
    pub delivered_at: Option<DateTime<Utc>>,
    pub failed_at: Option<DateTime<Utc>>,
}
```

**Fixed Code**:
```rust
pub struct WebhookEvent {
    pub id: EventId,
    pub tenant_id: TenantId,
    pub endpoint_id: EndpointId,
    pub source_event_id: String,
    pub idempotency_strategy: String,
    pub status: EventStatus,
    pub failure_count: u32,
    pub last_attempt_at: Option<DateTime<Utc>>,
    pub next_retry_at: Option<DateTime<Utc>>,
    pub headers: HashMap<String, String>,
    pub body: Bytes,
    pub content_type: String,

    /// Size of the payload in bytes.
    ///
    /// Must be between 1 and 10MB (10485760 bytes) to satisfy database
    /// CHECK constraint. Even empty payloads are stored as size 1.
    pub payload_size: i32,

    /// Result of signature validation (if signing_secret configured).
    ///
    /// None if validation not attempted, Some(true) if valid,
    /// Some(false) if invalid.
    pub signature_valid: Option<bool>,

    /// Error message from signature validation failure.
    ///
    /// Only populated when signature_valid is Some(false).
    pub signature_error: Option<String>,

    pub received_at: DateTime<Utc>,
    pub delivered_at: Option<DateTime<Utc>>,
    pub failed_at: Option<DateTime<Utc>>,

    /// Reference to immutable audit log entry in TigerBeetle.
    ///
    /// Populated after event is written to audit log for compliance.
    pub tigerbeetle_id: Option<Uuid>,
}
```

**Testing**:
```bash
# Compile check
cargo check

# Run tests
cargo test -p kapsel-core
```

**Commit Message**:
```
feat(core): add missing database fields to WebhookEvent struct

Adds four fields present in database but missing from domain model:
- payload_size: i32 (NOT NULL)
- signature_valid: Option<bool>
- signature_error: Option<String>
- tigerbeetle_id: Option<Uuid>

Without these fields, queries loading webhook_events from database
would fail with missing column errors.

Fixes audit finding 2.1.
```

---

### Fix 1.3: Add DeadLetter variant to EventStatus enum

**Priority**: ðŸ”´ CRITICAL
**File**: `crates/kapsel-core/src/models.rs`
**Estimated Time**: 10 minutes

**Current Code** (lines 148-189):
```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum EventStatus {
    Received,
    Pending,
    Delivering,
    Delivered,
    Failed,
}

impl fmt::Display for EventStatus {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        match self {
            Self::Received => write!(f, "received"),
            Self::Pending => write!(f, "pending"),
            Self::Delivering => write!(f, "delivering"),
            Self::Delivered => write!(f, "delivered"),
            Self::Failed => write!(f, "failed"),
        }
    }
}
```

**Fixed Code**:
```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "snake_case")]
pub enum EventStatus {
    Received,
    Pending,
    Delivering,
    Delivered,
    Failed,

    /// Event moved to dead letter queue after permanent failure.
    ///
    /// Terminal failure state for events that cannot be delivered even after
    /// all retries exhausted. Requires manual intervention or reprocessing.
    /// Used for debugging and compliance audit trail.
    DeadLetter,
}

impl fmt::Display for EventStatus {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        match self {
            Self::Received => write!(f, "received"),
            Self::Pending => write!(f, "pending"),
            Self::Delivering => write!(f, "delivering"),
            Self::Delivered => write!(f, "delivered"),
            Self::Failed => write!(f, "failed"),
            Self::DeadLetter => write!(f, "dead_letter"),
        }
    }
}
```

**Testing**:
```bash
# Compile check
cargo check

# Run tests
cargo test -p kapsel-core

# Verify serde deserialization
cargo test -p kapsel-core -- status
```

**Commit Message**:
```
feat(core): add DeadLetter variant to EventStatus enum

The database CHECK constraint allows 'dead_letter' status but the Rust
enum only had 5 variants. This caused deserialization failures when
loading events in dead_letter state.

Also changed serde rename from "lowercase" to "snake_case" to properly
handle dead_letter serialization.

Fixes audit finding 2.2.
```

---

### Fix 1.4: Add missing fields to Endpoint struct

**Priority**: ðŸ”´ CRITICAL
**File**: `crates/kapsel-core/src/models.rs`
**Estimated Time**: 20 minutes

**Current Code** (lines 262-321):
```rust
pub struct Endpoint {
    pub id: EndpointId,
    pub tenant_id: TenantId,
    pub url: String,
    pub name: String,
    pub signing_secret: Option<String>,
    pub signature_header: Option<String>,
    pub max_retries: u32,
    pub timeout_seconds: u32,
    pub circuit_state: CircuitState,
    pub circuit_failure_count: u32,
    pub circuit_last_failure_at: Option<DateTime<Utc>>,
    pub circuit_half_open_at: Option<DateTime<Utc>>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}
```

**Fixed Code**:
```rust
pub struct Endpoint {
    pub id: EndpointId,
    pub tenant_id: TenantId,
    pub url: String,
    pub name: String,

    /// Whether this endpoint is active and should receive webhooks.
    ///
    /// Inactive endpoints are skipped during delivery. Used for soft-disable
    /// without deleting endpoint configuration.
    pub is_active: bool,

    pub signing_secret: Option<String>,
    pub signature_header: Option<String>,
    pub max_retries: u32,
    pub timeout_seconds: u32,

    /// Retry backoff strategy: exponential, linear, or fixed.
    pub retry_strategy: String,

    pub circuit_state: CircuitState,
    pub circuit_failure_count: u32,

    /// Consecutive successes in half-open state.
    ///
    /// Used to determine when to transition from half-open back to closed.
    /// Typically requires 3 consecutive successes.
    pub circuit_success_count: u32,

    pub circuit_last_failure_at: Option<DateTime<Utc>>,
    pub circuit_half_open_at: Option<DateTime<Utc>>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,

    /// Soft delete timestamp.
    ///
    /// When present, endpoint is logically deleted but retained for audit.
    pub deleted_at: Option<DateTime<Utc>>,

    // Performance statistics (denormalized for dashboard queries)
    /// Total number of webhook events received for this endpoint.
    pub total_events_received: i64,

    /// Total number successfully delivered (status = delivered).
    pub total_events_delivered: i64,

    /// Total number permanently failed (status = failed or dead_letter).
    pub total_events_failed: i64,
}
```

**Testing**:
```bash
cargo check
cargo test -p kapsel-core
```

**Commit Message**:
```
feat(core): add missing database fields to Endpoint struct

Adds seven fields present in database but missing from domain model:
- is_active: bool (NOT NULL)
- retry_strategy: String (NOT NULL)
- circuit_success_count: u32 (NOT NULL)
- deleted_at: Option<DateTime<Utc>> (soft deletes)
- total_events_received: i64 (denormalized stats)
- total_events_delivered: i64
- total_events_failed: i64

Without these fields, endpoint management queries would fail.

Fixes audit finding 2.3.
```

---

### Fix 1.5: Add request_method to DeliveryAttempt struct

**Priority**: ðŸ”´ CRITICAL
**File**: `crates/kapsel-core/src/models.rs`
**Estimated Time**: 5 minutes

**Current Code** (lines 365-412):
```rust
pub struct DeliveryAttempt {
    pub id: Uuid,
    pub event_id: EventId,
    pub attempt_number: u32,
    pub request_url: String,
    pub request_headers: HashMap<String, String>,
    pub response_status: Option<u16>,
    pub response_headers: Option<HashMap<String, String>>,
    pub response_body: Option<String>,
    pub attempted_at: DateTime<Utc>,
    pub duration_ms: u32,
    pub error_type: Option<String>,
    pub error_message: Option<String>,
}
```

**Fixed Code**:
```rust
pub struct DeliveryAttempt {
    pub id: Uuid,
    pub event_id: EventId,
    pub attempt_number: u32,
    pub request_url: String,
    pub request_headers: HashMap<String, String>,

    /// HTTP method used for delivery request.
    ///
    /// Defaults to POST but endpoints may configure other methods.
    pub request_method: String,

    pub response_status: Option<u16>,
    pub response_headers: Option<HashMap<String, String>>,
    pub response_body: Option<String>,
    pub attempted_at: DateTime<Utc>,
    pub duration_ms: u32,
    pub error_type: Option<String>,
    pub error_message: Option<String>,
}
```

**Testing**:
```bash
cargo check
cargo test -p kapsel-core
```

**Commit Message**:
```
feat(core): add request_method field to DeliveryAttempt struct

The database has request_method TEXT NOT NULL DEFAULT 'POST' but the
struct was missing this field. This prevented recording non-POST
delivery attempts and caused query mismatches.

Fixes audit finding 2.4.
```

---

### Fix 1.6: Update test harness schema (add signature columns)

**Priority**: ðŸŸ¡ HIGH
**File**: `crates/test-harness/src/database.rs`
**Estimated Time**: 10 minutes

**Current Code** (lines 133-159):
```rust
sqlx::query(
    r#"
    CREATE TABLE IF NOT EXISTS webhook_events (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        tenant_id UUID NOT NULL,
        endpoint_id UUID NOT NULL,
        source_event_id TEXT NOT NULL,
        idempotency_strategy TEXT NOT NULL,
        status TEXT NOT NULL,
        failure_count INTEGER NOT NULL DEFAULT 0,
        last_attempt_at TIMESTAMPTZ,
        next_retry_at TIMESTAMPTZ,
        headers JSONB NOT NULL,
        body BYTEA NOT NULL,
        content_type TEXT NOT NULL,
        payload_size INTEGER NOT NULL,
        received_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        delivered_at TIMESTAMPTZ,
        failed_at TIMESTAMPTZ,
        tigerbeetle_id UUID,
        UNIQUE(tenant_id, endpoint_id, source_event_id),
        CHECK (payload_size > 0 AND payload_size <= 10485760)
    )
    "#,
)
.execute(pool)
.await?;
```

**Fixed Code**:
```rust
sqlx::query(
    r#"
    CREATE TABLE IF NOT EXISTS webhook_events (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        tenant_id UUID NOT NULL,
        endpoint_id UUID NOT NULL,
        source_event_id TEXT NOT NULL,
        idempotency_strategy TEXT NOT NULL,
        status TEXT NOT NULL,
        failure_count INTEGER NOT NULL DEFAULT 0,
        last_attempt_at TIMESTAMPTZ,
        next_retry_at TIMESTAMPTZ,
        headers JSONB NOT NULL,
        body BYTEA NOT NULL,
        content_type TEXT NOT NULL,
        payload_size INTEGER NOT NULL,
        signature_valid BOOLEAN,
        signature_error TEXT,
        received_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        delivered_at TIMESTAMPTZ,
        failed_at TIMESTAMPTZ,
        tigerbeetle_id UUID,
        UNIQUE(tenant_id, endpoint_id, source_event_id),
        CHECK (payload_size > 0 AND payload_size <= 10485760)
    )
    "#,
)
.execute(pool)
.await?;
```

**Testing**:
```bash
# Run test harness tests
cargo test -p test-harness

# Run integration tests
cargo test --test webhook_ingestion_test
```

**Commit Message**:
```
fix(test-harness): add signature validation columns to test schema

The test harness was missing signature_valid and signature_error
columns that exist in production migrations. This caused schema drift
where tests wouldn't catch signature validation bugs.

Fixes audit finding 9.1.
```

---

## Phase 1 Verification

After completing all Phase 1 fixes, run:

```bash
# 1. All tests pass
cargo make test

# 2. Property tests specifically
cargo test --test property_tests

# 3. Integration tests
cargo test --test webhook_ingestion_test
cargo test --test golden_sample_test

# 4. Clippy clean
cargo clippy --all-targets --all-features -- -D warnings

# 5. Documentation builds
cargo doc --no-deps --all-features

# 6. Format check
cargo fmt --all -- --check
```

All must pass before proceeding to Phase 2.

---

## Phase 2: High Priority Fixes (BEFORE NEW FEATURES)

### Fix 2.1: Update SPECIFICATION.md to match implementation

**Priority**: ðŸŸ¡ HIGH
**File**: `docs/SPECIFICATION.md`
**Estimated Time**: 1 hour

**Changes Required**:

1. **Status enum** (line 163):
   ```sql
   -- OLD:
   status TEXT NOT NULL, -- 'received', 'pending', 'delivering', 'success', 'failed'

   -- NEW:
   status TEXT NOT NULL CHECK (
       status IN ('received', 'pending', 'delivering', 'delivered', 'failed', 'dead_letter')
   ),
   ```

2. **Add missing webhook_events columns**:
   ```sql
   payload_size INTEGER NOT NULL,
   signature_valid BOOLEAN,
   signature_error TEXT,
   ```

3. **Add missing endpoints columns**:
   ```sql
   is_active BOOLEAN NOT NULL DEFAULT true,
   retry_strategy TEXT NOT NULL DEFAULT 'exponential',
   circuit_success_count INTEGER NOT NULL DEFAULT 0,
   deleted_at TIMESTAMPTZ,
   total_events_received BIGINT NOT NULL DEFAULT 0,
   total_events_delivered BIGINT NOT NULL DEFAULT 0,
   total_events_failed BIGINT NOT NULL DEFAULT 0,
   ```

4. **Add missing delivery_attempts columns**:
   ```sql
   request_method TEXT NOT NULL DEFAULT 'POST',
   ```

5. **Add tenants table** (completely missing):
   ```sql
   CREATE TABLE tenants (
       id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
       name TEXT NOT NULL,
       plan TEXT NOT NULL DEFAULT 'free' CHECK (plan IN ('free', 'starter', 'growth', 'scale', 'enterprise')),
       max_events_per_month INTEGER NOT NULL DEFAULT 10000,
       max_endpoints INTEGER NOT NULL DEFAULT 5,
       events_this_month INTEGER NOT NULL DEFAULT 0,
       api_key TEXT NOT NULL UNIQUE,
       api_key_hash TEXT NOT NULL,
       created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
       updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   );
   ```

6. **Add missing indexes**:
   ```sql
   CREATE INDEX idx_webhook_events_endpoint ON webhook_events(endpoint_id);
   CREATE INDEX idx_webhook_events_tigerbeetle ON webhook_events(tigerbeetle_id) WHERE tigerbeetle_id IS NOT NULL;
   CREATE INDEX idx_delivery_attempts_timing ON delivery_attempts(attempted_at);
   CREATE INDEX idx_endpoints_tenant ON endpoints(tenant_id);
   CREATE INDEX idx_endpoints_circuit ON endpoints(circuit_state) WHERE circuit_state != 'closed';
   ```

**Commit Message**:
```
docs(spec): update SPECIFICATION.md to match implementation

Brings SPEC up to date with actual implementation:
- Change status enum from 'success' to 'delivered'
- Add 'dead_letter' status
- Add payload_size, signature_valid, signature_error columns
- Add endpoint management columns
- Document full tenants table
- Add all production indexes

The migration files are the source of truth; SPEC now reflects reality.

Fixes audit finding 1.1-1.4.
```

---

### Fix 2.2: Implement signature validation

**Priority**: ðŸŸ¡ HIGH (Security requirement)
**Files**:
- `crates/kapsel-api/src/handlers/ingest.rs`
- `crates/kapsel-api/src/crypto.rs` (new)
**Estimated Time**: 2-3 hours

**Implementation Plan**:

1. Create crypto module for HMAC validation
2. Add signature validation to ingestion flow
3. Store validation result in database
4. Return 400 Bad Request on invalid signature
5. Add tests for signature validation

**Commit Message**:
```
feat(api): implement HMAC-SHA256 signature validation

Implements SPEC FR-3.1 signature validation requirements:
- HMAC-SHA256 validation for webhook authenticity
- Configurable signature header per endpoint
- Stores validation result in signature_valid column
- Returns 400 Bad Request for invalid signatures
- Supports Stripe, GitHub, generic webhook signatures

Fixes audit finding 4.2.
```

---

## Phase 3: Medium Priority (Nice to Have)

### Fix 3.1: Implement missing API endpoints

**Priority**: ðŸŸ¢ MEDIUM
**Estimated Time**: 3-4 hours

Implement:
- POST /v1/endpoints (create endpoint)
- GET /v1/events/{event_id} (event status)

### Fix 3.2: Add missing HTTP response codes

**Priority**: ðŸŸ¢ MEDIUM
**Estimated Time**: 1 hour

Add:
- 400 Bad Request (signature validation)
- 429 Too Many Requests (rate limiting)
- 503 Service Unavailable (overload)

---

## Git Workflow

All commits should follow conventional commits:

```bash
git checkout -b fix/audit-critical-issues

# Make Fix 1.1
git add crates/kapsel-api/src/handlers/ingest.rs
git commit -m "fix(api): add payload_size column to webhook_events INSERT"

# Make Fix 1.2
git add crates/kapsel-core/src/models.rs
git commit -m "feat(core): add missing database fields to WebhookEvent struct"

# Continue for all fixes...

# After Phase 1 complete and all tests pass:
git push origin fix/audit-critical-issues

# Create PR with title: "fix: resolve critical audit findings (schema alignment)"
```

---

## Success Criteria

**Phase 1 Complete When**:
- âœ… All tests pass (`cargo make test`)
- âœ… Property tests pass with empty webhooks
- âœ… No clippy warnings
- âœ… Documentation builds
- âœ… All domain models match database schema

**Phase 2 Complete When**:
- âœ… SPECIFICATION.md matches implementation
- âœ… Signature validation implemented and tested

**Phase 3 Complete When**:
- âœ… All SPEC-required endpoints implemented
- âœ… All SPEC-required response codes present
